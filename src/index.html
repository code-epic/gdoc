<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Start your development with a Dashboard for Bootstrap 4.">
  <meta name="author" content="Creative Tim">
  <title>Gestión de Documentos</title>
  <!-- Favicon -->
  <link href="./assets/img/brand/favicon.ico" rel="icon" type="image/png">
  <!-- Fonts -->
  <!--  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">-->
  <!-- Icons -->
  <link href="./assets/vendor/nucleo/css/nucleo.css" rel="stylesheet">
  <link href="./assets/vendor/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">


  <!--  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">-->
  <!--  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">-->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1976d2">
</head>

<body class="mat-typography">
  <app-root></app-root>
  <noscript>Please enable JavaScript to continue using this application.</noscript>
</body>

<script>

  (function () {
    // Configuración
    const appId = window.APP_ID || 'external-app';
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    const originalFetch = window.fetch;
    const OriginalXHR = window.XMLHttpRequest;

    function sendToParent(type, message, details = {}) {
      if (window.parent) {
        window.parent.postMessage({
          type: 'SDC_LOG',
          payload: {
            app_id: appId,
            log_type: type, // 'FETCH', 'XHR', 'ERROR', 'INFO'
            message: message,
            details: details // Objeto extra con status, url, payload, response
          }
        }, '*');
      }
    }

    // 1. Interceptar Console
    console.log = function (...args) {
      originalLog.apply(console, args);
      sendToParent('INFO', args.join(' '));
    };

    console.error = function (...args) {
      originalError.apply(console, args);
      // Convertir Error objects a string si es necesario
      const msg = args.map(a => (a instanceof Error ? a.message + '\n' + a.stack : a)).join(' ');
      sendToParent('ERROR', msg);
    };

    console.warn = function (...args) {
      originalWarn.apply(console, args);
      sendToParent('WARN', args.join(' '));
    };

    // 2. Interceptar Fetch (Red)
    window.fetch = async function (...args) {
      const [resource, config] = args;
      const url = resource.toString();
      const method = (config && config.method) ? config.method : 'GET';
      const payload = (config && config.body) ? config.body : '[No Payload]';

      // NO reportamos el inicio del request para reducir ruido, solo resultados relevantes.

      try {
        const response = await originalFetch(...args);

        // Solo reportar errores HTTP (400+)
        if (response.status >= 400) {
          // Intentar leer el cuerpo del error sin consumir el stream principal (clonando)
          let responseBody = '[Body Error]';
          try {
            responseBody = await response.clone().text();
          } catch (e) { }

          sendToParent('FETCH', `HTTP ${response.status} ${method} ${url}`, {
            url: url,
            method: method,
            status: response.status,
            payload: payload,
            response: responseBody
          });
        }

        return response;
      } catch (err) {
        sendToParent('ERROR', `Fetch Network Error: ${url} - ${err.message}`);
        throw err;
      }
    };

    // 3. Interceptar XHR (XMLHttpRequest)
    window.XMLHttpRequest = function () {
      const xhr = new OriginalXHR();
      let method = 'GET';
      let url = '';
      let payload = null;

      // Sobrescribir open para capturar metodo y url
      const originalOpen = xhr.open;
      xhr.open = function (m, u, ...args) {
        method = m;
        url = u;
        return originalOpen.apply(xhr, [m, u, ...args]);
      };

      // Sobrescribir send para capturar payload
      const originalSend = xhr.send;
      xhr.send = function (body) {
        payload = body;
        return originalSend.apply(xhr, [body]);
      };

      // Escuchar eventos de carga/error
      xhr.addEventListener('loadend', function () {
        // Filtrar solo errores (400+)
        if (xhr.status >= 400) {
          sendToParent('XHR', `HTTP ${xhr.status} ${method} ${url}`, {
            url: url,
            method: method,
            status: xhr.status,
            payload: payload,
            response: xhr.responseText // XHR permite leer responseText despues de finalizar
          });
        }
      });

      xhr.addEventListener('error', function () {
        sendToParent('ERROR', `XHR Network Error: ${method} ${url}`);
      });

      return xhr;
    };

    // Copiar propiedades estáticas de XHR si las hubiera (constantes, etc)
    Object.assign(window.XMLHttpRequest, OriginalXHR);

    sendToParent('INFO', `Monitor (XHR/Fetch) iniciado para ${appId}`);

  })();



</script>

</html>